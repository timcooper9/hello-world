CREATE TABLE reconciliation(transaction_id text, settlement_date datetime, merchant_name text, merchant_account text, mid integer, transaction_currency text, transaction_amount real, fee_amount real, interchange_amount real, card_brand text, order_id text, interchange_description text, card_type text, region_relation text, processing_date datetime);

CREATE TABLE transactions(transaction_id text, transaction_type text, transaction_status text, created_datetime datetime, created_timezone text, settlement_date datetime, disbursement_date datetime, merchant_account text, currency_iso text, amount_authorised real, amount_submitted_for_settlement real, order_id text, descriptor_name text, card_brand text, cardholder name text, first_six text, last_four text, expiration_date datetime, customer_id text, payment_method_token text, cvv_response text, settlement_amount text, settlement_currency text, settlement_batch_id text, country_of_issuance text, issuing_bank text, commercial text, prepaid text, debit text, product_id text, three_ds_status text, three_ds_eci text, three_ds_version text, three_ds_challenge_requested text, three_ds_exemption_requested text);

sqlite> with total as (select sum(fee_amount) as total from reconciliation), total_TPV as (select sum(transaction_amount) as total from reconciliation) select country_of_issuance, sum(transaction_amount) as TPV, sum(transaction_amount)/total_TPV.total*100 as TPV_as_pct_of_total, sum(fee_amount)/sum(transaction_amount)*-100 as fee_pct, sum(fee_amount)/total.total*100 as fee_pct_of_total from total, total_TPV, transactions inner join reconciliation where transactions.transa
ction_id = reconciliation.transaction_id group by 1 order by 2 desc;
